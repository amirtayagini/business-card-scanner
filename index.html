<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“‡ Free Business Card Scanner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .icon-large {
            font-size: 50px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-area h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .upload-area p {
            color: #666;
            font-size: 14px;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: #4CAF50;
        }

        .button.secondary:hover {
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-container {
            margin: 20px 0;
            display: none;
        }

        .preview-container img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .result-container {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            display: none;
            border-left: 5px solid #667eea;
        }

        .result-container h3 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-row {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .info-label {
            flex: 0 0 120px;
            font-weight: 600;
            color: #555;
        }

        .info-value {
            flex: 1;
            color: #333;
        }

        .info-value.empty {
            color: #999;
            font-style: italic;
        }

        .loader {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            padding: 12px 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 5px solid #17a2b8;
        }

        .camera-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .hidden-input {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        footer a {
            color: white;
            text-decoration: none;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                border-radius: 15px;
            }
            
            .info-row {
                flex-direction: column;
            }
            
            .info-label {
                flex: none;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icon-large">
                <i class="fas fa-id-card"></i>
            </div>
            <h1>Business Card Scanner</h1>
            <p>Free OCR scanning directly to Google Sheets</p>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Upload Business Card</h3>
            <p>Drag & drop or click to select image</p>
            <p style="font-size: 12px; margin-top: 10px;">JPG, PNG, WebP (Max 5MB)</p>
        </div>

        <!-- Camera Input (hidden) -->
        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-input">
        
        <!-- Camera Button -->
        <button class="camera-button" onclick="openCamera()">
            <i class="fas fa-camera"></i> Take Photo with Camera
        </button>

        <!-- File Input (hidden) -->
        <input type="file" id="fileInput" accept="image/*" class="hidden-input">

        <!-- Preview -->
        <div class="preview-container" id="previewContainer">
            <img id="imagePreview" alt="Preview">
        </div>

        <!-- Buttons -->
        <button class="button" id="processButton" onclick="processImage()" disabled>
            <i class="fas fa-search"></i> Extract Information
        </button>

        <!-- Loader -->
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <p style="margin-top: 10px;">Processing image...</p>
        </div>

        <!-- Results -->
        <div class="result-container" id="resultContainer">
            <h3><i class="fas fa-check-circle"></i> Extracted Information</h3>
            <div id="extractedData">
                <!-- Data will be inserted here -->
            </div>
            
            <button class="button secondary" id="saveButton" onclick="saveToSheets()">
                <i class="fas fa-save"></i> Save to Google Sheets
            </button>
        </div>

        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
            <i class="fas fa-info-circle"></i> No data is stored on our servers. Direct to Google Sheets.
        </div>
    </div>

    <footer>
        <p>Business Card Scanner | Works on all devices</p>
        <p>Powered by Tesseract.js + Google Sheets</p>
        <p>AY</p>
    </footer>

    <!-- Tesseract.js library -->
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    
    <script>
        // Global variables
        let selectedFile = null;
        let extractedText = '';
        let extractedData = {};

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const processButton = document.getElementById('processButton');
        const loader = document.getElementById('loader');
        const resultContainer = document.getElementById('resultContainer');
        const extractedDataDiv = document.getElementById('extractedData');
        const statusMessage = document.getElementById('statusMessage');
        const saveButton = document.getElementById('saveButton');

        // Google Apps Script Web App URL 
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKYuUlzh3FYQxcBK_tEJrMmVhHkCOWTyQH_FS9pqS6D3hw-BajtUzWznmbPfCjDdKGDA/exec';

        // Upload area click handler
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // File input change handler
        fileInput.addEventListener('change', handleFileSelect);
        cameraInput.addEventListener('change', handleFileSelect);

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                selectedFile = e.dataTransfer.files[0];
                validateAndPreviewFile(selectedFile);
            }
        });

        function openCamera() {
            cameraInput.click();
        }

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            validateAndPreviewFile(selectedFile);
        }

        function validateAndPreviewFile(file) {
            // Reset previous results
            hideStatus();
            resultContainer.style.display = 'none';
            
            // Validate file
            if (!file.type.match('image.*')) {
                showStatus('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showStatus('File size should be less than 5MB', 'error');
                return;
            }
            
            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                previewContainer.style.display = 'block';
                processButton.disabled = false;
                showStatus('Image ready for processing', 'info');
            };
            reader.readAsDataURL(file);
        }

        async function processImage() {
            if (!selectedFile) {
                showStatus('Please select an image first', 'error');
                return;
            }
            
            // Show loader, hide other elements
            loader.style.display = 'block';
            processButton.disabled = true;
            resultContainer.style.display = 'none';
            hideStatus();
            
            try {
                // Convert file to base64
                const base64Image = await fileToBase64(selectedFile);
                
                // Use Tesseract.js for OCR (client-side, free, no API key needed)
                showStatus('Extracting text from image...', 'info');
                
                const worker = await Tesseract.createWorker({
                    logger: m => console.log(m),
                    errorHandler: err => console.error(err)
                });
                
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                
                // Configure for better business card recognition
                await worker.setParameters({
                    tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@.-+() ',
                    preserve_interword_spaces: '1'
                });
                
                const result = await worker.recognize(base64Image);
                extractedText = result.data.text;
                
                await worker.terminate();
                
                // Analyze the extracted text
                extractedData = analyzeBusinessCardText(extractedText);
                
                // Display results
                displayResults(extractedData);
                
                // Show success message
                showStatus('Information extracted successfully!', 'success');
                
            } catch (error) {
                console.error('OCR Error:', error);
                showStatus('Error processing image: ' + error.message, 'error');
            } finally {
                loader.style.display = 'none';
                processButton.disabled = false;
            }
        }

        function analyzeBusinessCardText(text) {
            // This is a simplified version of your analysis logic
            const data = {
                company: '',
                name: '',
                position: '',
                contact_number: '',
                personal_email: '',
                company_number: '',
                company_email: ''
            };
            
            const lines = text.split('\n').filter(line => line.trim());
            
            // Extract emails
            const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            const emails = text.match(emailRegex) || [];
            
            // Extract phone numbers
            const phoneRegex = /(\+?\d{1,4}?[-.\s]?\(?\d{1,4}\)?[-.\s]?\d{1,4}[-.\s]?\d{1,9})/g;
            const phones = text.match(phoneRegex) || [];
            
            // Simple heuristics for name (first line that looks like a name)
            for (let line of lines) {
                if (!data.name && line.trim().split(' ').length >= 2 && line.trim().split(' ').length <= 4) {
                    if (!/\d/.test(line) && !line.includes('@')) {
                        data.name = line.trim();
                        break;
                    }
                }
            }
            
            // Company (look for keywords)
            const companyKeywords = ['Sdn', 'Bhd', 'Inc', 'Ltd', 'LLC', 'Corp', 'GmbH', 'Co.', 'Enterprise', 'Solutions', 'Group'];
            for (let line of lines) {
                if (!data.company && companyKeywords.some(keyword => line.includes(keyword))) {
                    data.company = line.trim();
                    break;
                }
            }
            
            // Position (common job titles)
            const positionKeywords = [
                'Manager', 'Director', 'Officer', 'Engineer', 'Staff', 'Consultant', 'Specialist', 
                'Analyst', 'Coordinator', 'Assistant', 'Chief', 'Executive', "Chairman", "President"
            ];
            for (let line of lines) {
                const lineLower = line.toLowerCase();
                if (!data.position && positionKeywords.some(keyword => 
                    lineLower.includes(keyword.toLowerCase()))) {
                    data.position = line.trim();
                    break;
                }
            }
            
            // Classify emails
            if (emails.length > 0) {
                if (emails.length === 1) {
                    if (data['name'] && name_in_email(data['name'], emails[0])) {
                        data['personal_email'] = emails[0];
                    }
                    data['company_email'] = emails[0];
                } else {
                    for (let email of emails) {
                        if (data['name'] && name_in_email(data['name'], email)) {
                            if (!data['personal_email']) {
                                data['personal_email'] = email;
                            }
                        } else {
                            if (!data['company_email']) {
                                data['company_email'] = email;
                            }
                        }
                    }
                }

            
            // Classify phone numbers
            if (all_phones && all_phones.length > 0) {
                let mobile_numbers = [];
                let landline_numbers = [];

                for (let phone of all_phones) {
                    let phone_clean = phone.replace(/[^\d+]/g, '');

                    if (
                        phone_clean.startsWith('601') ||
                        phone_clean.startsWith('+601') ||
                        phone_clean.startsWith('01')
                    ) {
                        mobile_numbers.push(phone);
                    } else if (
                        phone_clean.startsWith('603') ||
                        phone_clean.startsWith('+603') ||
                        phone_clean.startsWith('03')
                    ) {
                        landline_numbers.push(phone);
                    } else {
                        if (phone_clean.length <= 12) {
                            mobile_numbers.push(phone);
                        } else {
                            landline_numbers.push(phone);
                        }
                    }
                }

                if (mobile_numbers.length > 0) {
                    data['contact_number'] = mobile_numbers[0];
                }
                if (landline_numbers.length > 0) {
                    data['company_number'] = landline_numbers[0];
                }
            }

            console.log(data);
            
            return data;
        }

        function displayResults(data) {
            const html = `
                <div class="info-row">
                    <div class="info-label">Company:</div>
                    <div class="info-value ${!data.company ? 'empty' : ''}">
                        ${data.company || 'Not found'}
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Name:</div>
                    <div class="info-value ${!data.name ? 'empty' : ''}">
                        ${data.name || 'Not found'}
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Position:</div>
                    <div class="info-value ${!data.position ? 'empty' : ''}">
                        ${data.position || 'Not found'}
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Contact Number:</div>
                    <div class="info-value ${!data.contact_number ? 'empty' : ''}">
                        ${data.contact_number || 'Not found'}
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Email:</div>
                    <div class="info-value ${!(data.personal_email || data.company_email) ? 'empty' : ''}">
                        ${data.personal_email || data.company_email || 'Not found'}
                    </div>
                </div>
            `;
            
            extractedDataDiv.innerHTML = html;
            resultContainer.style.display = 'block';
            saveButton.disabled = false;
        }

        async function saveToSheets() {
            if (!extractedData || Object.keys(extractedData).length === 0) {
                showStatus('No data to save', 'error');
                return;
            }
            
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                // Send data to Google Apps Script
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for cross-origin
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(extractedData)
                });
                
                // Since we use no-cors, we can't read the response directly
                // But we know it worked if no error
                showStatus('âœ… Data saved to Google Sheets!', 'success');
                
                // Reset form after 3 seconds
                setTimeout(() => {
                    resetForm();
                }, 3000);
                
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Error saving to Google Sheets', 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save to Google Sheets';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
        }

        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        function resetForm() {
            selectedFile = null;
            extractedText = '';
            extractedData = {};
            
            fileInput.value = '';
            cameraInput.value = '';
            previewContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            processButton.disabled = true;
            hideStatus();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Initialize
        console.log('Business Card Scanner loaded');
        console.log('Replace GOOGLE_SCRIPT_URL with your Google Apps Script URL');
    </script>
</body>
</html>
